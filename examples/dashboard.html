<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechMonitor PRO | Safe & Reactive cDOM</title>
    <script src="../index.js"></script>
    <link rel="stylesheet" href="dashboard.css">
</head>

<body>
    <script>
        const { state, signal, helper, schema } = cDOM;

        // --- SCHEMAS ---
        schema('Percentage', { type: 'number', minimum: 0, maximum: 100 });
        schema('Metric', { type: 'number', minimum: 0 });
        schema('LogEntry', {
            type: 'object',
            required: ['t', 'm', 's'],
            properties: {
                t: { type: 'string' },
                m: { type: 'string' },
                s: { enum: ['info', 'warning', 'danger'] }
            }
        });
        schema('LogList', { type: 'array', items: 'LogEntry' });

        // --- STATE ---
        const cpu = signal(45, { name: 'cpuUsage', schema: 'Percentage', transform: 'Integer', storage: localStorage });
        const mem = signal(62, { name: 'memUsage', schema: 'Percentage', transform: 'Number', storage: localStorage });
        const req = signal(850, { name: 'reqCount', schema: 'Metric', transform: 'Integer', storage: localStorage });
        const lat = signal(24, { name: 'latency', schema: 'Metric', transform: 'Integer', storage: localStorage });

        const history = state(Array(30).fill(30), { name: 'perfHistory', storage: localStorage });
        const logs = state([
            { t: '08:00:00.00', m: 'Security protocol initialized', s: 'info' },
            { t: '08:01:00.00', m: 'Node cluster synced', s: 'info' }
        ], { name: 'liveLogs', schema: 'LogList', storage: localStorage });

        // --- CUSTOM HELPERS ---
        // Only keeping the one specific to business logic (Class generation)
        helper('LOG_LEVEL_CLASS', (s) => `log-${s === 'danger' ? 'err' : s === 'warning' ? 'warn' : 'info'}`);

        // Simulation Loop
        const startSimulation = () => {
            setInterval(() => {
                cpu.value = Math.floor(Math.random() * 30 + 35);
                mem.value = Math.min(95, Math.max(20, mem.value + (Math.random() * 6 - 3)));
                req.value += Math.floor(Math.random() * 20);
                lat.value = Math.floor(Math.random() * 15 + 10);

                history.shift();
                history.push(cpu.value);

                if (Math.random() > 0.5) {
                    const msgs = [
                        { m: 'High traffic on endpoint /api/v1/auth', s: 'warning' },
                        { m: 'Database query latency optimized', s: 'info' },
                        { m: 'Unauthorized access attempt blocked', s: 'danger' }
                    ];
                    const msg = msgs[Math.floor(Math.random() * msgs.length)];
                    const now = new Date();
                    const ts = now.toTimeString().split(' ')[0] + '.' + Math.floor(now.getMilliseconds() / 10).toString().padStart(2, '0');
                    logs.unshift({ t: ts, ...msg });
                    if (logs.length > 8) logs.pop();
                }
            }, 2000);
        };

        // --- COMPONENT FACTORY ---
        const Metric = (label, valueObj, unit, icon) => {
            return {
                "div": {
                    "class": "card",
                    "children": [
                        { "div": { "class": "card-label", "children": [label, icon] } },
                        {
                            "div": {
                                "class": "card-val", "children": [
                                    valueObj,
                                    { "span": { "class": "card-unit", "children": [unit] } }
                                ]
                            }
                        },
                        {
                            "div": {
                                "class": "progress", "children": [
                                    {
                                        "div": {
                                            "class": "progress-bar",
                                            "style": {
                                                // Using standard helpers: concat, min, max
                                                "width": { "=concat": [{ "=min": [100, { "=max": [0, valueObj] }] }, "%"] }
                                            }
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            };
        };

        // --- APP RENDER ---
        cDOM({
            "div": {
                "style": "display: contents",
                "oncreate": startSimulation,
                "children": [
                    {
                        "div": {
                            "class": "sidebar", "children": [
                                { "div": { "class": "logo", "children": ["â—ˆ TechMonitor"] } },
                                { "p": { "style": "color: var(--text-dim); font-size: 0.75rem;", "children": ["SECURE ENVIRONMENT ACTIVE"] } }
                            ]
                        }
                    },
                    {
                        "div": {
                            "class": "main", "children": [
                                {
                                    "header": {
                                        "class": "header", "children": [
                                            {
                                                "div": {
                                                    "class": "title", "children": [
                                                        { "h1": "System Overview" },
                                                        { "p": { "style": "color: var(--text-dim)", "children": ["Real-time metrics via Standard Helpers"] } }
                                                    ]
                                                }
                                            },
                                            { "div": { "class": "status", "children": ["â— SYSTEM READY"] } }
                                        ]
                                    }
                                },
                                {
                                    "div": {
                                        "class": "grid", "children": [
                                            Metric('Process Load', { "=": "/cpuUsage" }, '%', 'âš¡'),
                                            // Using standard helpers 'round'
                                            Metric('Memory Heap', { "=round": [{ "=": "/memUsage" }, 1] }, '%', 'ðŸ’¾'),
                                            // Using standard helpers 'fixed' and 'divide'
                                            Metric('Net Throughput', { "=fixed": [{ "=divide": [{ "=": "/reqCount" }, 10] }, 1] }, 'k/s', 'ðŸš€'),
                                            Metric('Network Jitter', { "=": "/latency" }, 'ms', 'ðŸ“¡')
                                        ]
                                    }
                                },
                                {
                                    "div": {
                                        "class": "chart-section", "children": [
                                            {
                                                "div": {
                                                    "class": "card", "children": [
                                                        { "div": { "class": "card-label", "children": ["Resource History"] } },
                                                        {
                                                            "div": {
                                                                "class": "chart-box",
                                                                "children": () => history.map(v => ({
                                                                    "div": {
                                                                        "class": "bar-wrap", "children": [
                                                                            { "div": { "class": "bar", "style": `height: ${v}%` } }
                                                                        ]
                                                                    }
                                                                }))
                                                            }
                                                        }
                                                    ]
                                                }
                                            },
                                            {
                                                "div": {
                                                    "class": "card", "children": [
                                                        { "div": { "class": "card-label", "children": ["Live Integrity Logs"] } },
                                                        {
                                                            "div": {
                                                                "class": "logs",
                                                                "children": () => logs.map(l => ({
                                                                    "div": {
                                                                        "class": {
                                                                            "=concat": ["log ", { "=LOG_LEVEL_CLASS": [l.s] }]
                                                                        },
                                                                        "children": [
                                                                            {
                                                                                "div": {
                                                                                    "class": "log-meta", "children": [
                                                                                        { "span": { "style": "font-weight: 700", "children": [l.s.toUpperCase()] } },
                                                                                        { "span": { "children": [l.t] } }
                                                                                    ]
                                                                                }
                                                                            },
                                                                            { "div": { "children": [l.m] } }
                                                                        ]
                                                                    }
                                                                }))
                                                            }
                                                        }
                                                    ]
                                                }
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        }, { target: document.body, location: 'innerhtml' });

    </script>
</body>

</html>